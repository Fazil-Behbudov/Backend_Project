<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enter Driving Experience</title>
    <style>
        body {
            font-family: Verdana, Geneva, Tahoma, sans-serif;
            background: linear-gradient(135deg, #eef2f7 0%, #f7fbff 100%);
            padding: 12px;
            margin: 0;
        }

        header {
            background: #1a1a1a;
            color: #fff;
            text-align: center;
            padding: 22px 0;
            margin: 0 0 24px 0;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
        }

        header h1 {
            margin: 0;
        }

        .back-button {
            position: absolute;
            top: 20px;
            left: 20px;
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            padding: 10px 20px;
            text-decoration: none;
            border-radius: 30px;
            font-weight: bold;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
        }

        .back-button:hover {
            background: linear-gradient(135deg, #3a94ff 0%, #00d9e8 100%);
        }

        form {
            max-width: 760px;
            margin: auto;
            background: white;
            padding: 28px;
            border-radius: 16px;
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.12);
            border: 1px solid #e6ecf5;
        }

        fieldset {
            margin-bottom: 24px;
            border: 1px solid #d8e0eb;
            padding: 20px;
            border-radius: 12px;
            background: linear-gradient(180deg, rgba(79, 172, 254, 0.05) 0%, rgba(255, 255, 255, 0.8) 100%);
        }

        legend {
            font-weight: bold;
            font-size: 18px;
            color: #0f2745;
            padding: 6px 12px;
            border-radius: 10px;
            background: #eef4ff;
            border: 1px solid #dbe4ff;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.06);
        }
        
        .time-inputs {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }
        
        .time-input-group {
            flex: 1;
            min-width: 220px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #333;
        }
        
        input[type="text"],
        input[type="number"],
        input[type="date"],
        input[type="time"],
        select {
            width: 100%;
            padding: 12px 15px;
            font-size: 14px;
            border: 2px solid #d8e0eb;
            border-radius: 8px;
            margin-bottom: 16px;
            font-family: inherit;
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }
        
        input[type="text"]:focus,
        input[type="number"]:focus,
        input[type="date"]:focus,
        input[type="time"]:focus,
        select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        input[required]:invalid:not(:focus) {
            border-color: #ef4444;
        }

        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 14px 24px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 16px;
            width: 100%;
            transition: transform 0.2s, box-shadow 0.2s;
            box-shadow: 0 10px 25px rgba(118, 75, 162, 0.25);
        }

        button:hover {
            transform: translateY(-1px);
            box-shadow: 0 12px 30px rgba(118, 75, 162, 0.3);
        }

        select[multiple] {
            height: 100px;
        }

        small {
            display: block;
            margin-top: -10px;
            margin-bottom: 15px;
            color: #666;
        }

        .add-option-row {
            display: flex;
            gap: 8px;
            align-items: center;
            margin-top: 8px;
            margin-bottom: 15px;
        }

        .add-option-row input {
            flex: 1;
            padding: 8px;
            margin-bottom: 0;
        }

        .add-option-row button {
            width: auto;
            padding: 8px 16px;
            margin-bottom: 0;
        }

        footer {
            text-align: center;
            margin-top: 30px;
            padding: 20px;
            background-color: #1a1a1a;
            color: #fff;
        }

        footer p {
            margin: 5px 0;
        }

        @media (max-width: 768px) {
            form { padding: 20px; border-radius: 12px; }
            fieldset { padding: 16px; }
            .back-button { position: relative; left: 0; top: 0; margin: 10px; border-radius: 24px; }
            button { padding: 12px 20px; }
        }
        
        @media (max-width: 480px) {
            h1 {
                font-size: 22px;
                padding: 18px 10px;
            }
            
            form {
                padding: 16px;
                margin: 12px;
            }
            
            fieldset {
                padding: 12px;
            }
            
            legend {
                font-size: 14px;
                padding: 0 8px;
            }
            
            label {
                font-size: 13px;
            }
            
            input, select, textarea {
                font-size: 14px;
                padding: 10px;
            }
            
            button {
                font-size: 14px;
                padding: 10px 16px;
            }
        }
    </style>
    <script>
        function addOptions(selectId, options) {
            const select = document.getElementById(selectId);
            if (!select) return;
            select.innerHTML = '';

            // Only add a blank placeholder for fields where user can add new values
            if (selectId === 'weather' || selectId === 'traffic' || selectId === 'roadType') {
                const placeholder = document.createElement('option');
                placeholder.value = '';
                placeholder.textContent = '— Select (optional) —';
                placeholder.selected = true;
                select.appendChild(placeholder);
            }

            options.forEach(function(option) {
                const opt = document.createElement("option");
                opt.value = option.id;
                opt.textContent = option.label;
                select.appendChild(opt);
            });
        }

        async function loadOptions() {
            try {
                const res = await fetch('api/get_options.php');
                const json = await res.json();
                if (!json.success) throw new Error(json.message || 'Failed to load options');
                const data = json.data;

                addOptions('weather', data.weather);
                addOptions('traffic', data.traffic);
                addOptions('roadType', data.roadType);
                addOptions('timeOfDay', data.timeOfDay);
                addOptions('maneuvers', data.maneuver);
            } catch (e) {
                console.error(e);
                alert('❌ Error loading options: ' + e.message);
            }
        }

        // Load options when the page is ready
        document.addEventListener('DOMContentLoaded', loadOptions);
    </script>
</head>
<body>
    <nav>
        <a href="index.html" class="back-button" aria-label="Back to home">← Back to Home</a>
    </nav>
    
    <header>
        <h1>Enter Driving Experience</h1>
    </header>

    <main>
        <form id="drivingForm" onsubmit="handleSubmit(event)">
            <fieldset>
                <legend>User Information</legend>
                <label for="userName">Your Name:</label>
                <input type="text" id="userName" name="userName" required placeholder="Enter your name">

            <label for="age">Age:</label>
            <input type="number" id="age" name="age" min="16" max="99" placeholder="Your age (optional)">
        </fieldset>

        <fieldset>
            <legend>Trip Details</legend>
            <label for="date">Date of Experience:</label>
            <input type="date" id="date" name="date" required>

            <div class="time-inputs">
                <div class="time-input-group">
                    <label for="startTime">Start Time:</label>
                    <input type="time" id="startTime" name="startTime" required>
                </div>
                <div class="time-input-group">
                    <label for="endTime">End Time:</label>
                    <input type="time" id="endTime" name="endTime" required>
                </div>
            </div>

            <label for="mileage">Mileage (in km):</label>
            <input type="number" id="mileage" name="mileage" step="0.1" min="0" required placeholder="Distance in kilometers">

            <label for="timeOfDay">Time of Day:</label>
            <select name="idTimeOfDay" id="timeOfDay" required>
                <option value="">Select time of day...</option>
            </select>
        </fieldset>

        <fieldset>
            <legend>Driving Conditions</legend>
            
            <label for="weather">Weather Condition:</label>
            <select name="idWeather" id="weather">
                <option value="">Select weather condition...</option>
            </select>
            <div class="add-option-row">
                <input type="text" id="newWeather" name="newWeatherType" placeholder="Add new weather (e.g., Foggy, Snowy)">
            </div>

            <label for="traffic">Traffic Condition:</label>
            <select name="idTraffic" id="traffic">
                <option value="">Select traffic condition...</option>
            </select>
            <div class="add-option-row">
                <input type="text" id="newTraffic" name="newTrafficType" placeholder="Add new traffic (e.g., Congested, Clear)">
            </div>

            <label for="roadType">Road Type:</label>
            <select name="idRoadType" id="roadType">
                <option value="">Select road type...</option>
            </select>
                <div class="add-option-row">
                    <input type="text" id="newRoadType" name="newRoadTypeName" placeholder="Add new road type (e.g., Mountain pass, Bridge)">
                </div>
        </fieldset>

        <fieldset>
            <legend>Maneuvers (Optional)</legend>
            <label for="maneuvers">Select Maneuver Practiced:</label>
            <select name="idManeuver" id="maneuvers">
                <option value="">Select a maneuver (optional)...</option>
            </select>
        </fieldset>

        <button type="submit">Save Driving Experience</button>
        </form>
    </main>

    <footer>
        <p>&copy; 2025 Driving Experience Assistant. All rights reserved.</p>
    </footer>

    <div class="toast-container" id="toastContainer" style="position:fixed; top:18px; right:18px; display:flex; flex-direction:column; gap:10px; z-index:2000;"></div>

    <script>
        function showToast(message, type = 'success') {
            const container = document.getElementById('toastContainer');
            if (!container) return;
            const div = document.createElement('div');
            div.textContent = message;
            div.style.minWidth = '240px';
            div.style.padding = '12px 14px';
            div.style.borderRadius = '12px';
            div.style.color = '#fff';
            div.style.boxShadow = '0 14px 30px rgba(15,23,42,0.22)';
            div.style.background = type === 'error' ? 'linear-gradient(135deg, #f5576c 0%, #f093fb 100%)' : 'linear-gradient(135deg, #43e97b 0%, #38f9d7 100%)';
            div.style.animation = 'fadeIn 0.25s ease, fadeOut 0.4s ease 3.2s forwards';
            container.appendChild(div);
            setTimeout(() => div.remove(), 3600);
        }

        function handleSubmit(event) {
            event.preventDefault();
            
            // Get form data
            const formData = new FormData(event.target);
            
            const data = {
                userName: formData.get('userName'),
                age: formData.get('age') ? parseInt(formData.get('age')) : null,
                mileage: parseFloat(formData.get('mileage')),
                date: formData.get('date'),
                startTime: formData.get('startTime') || null,
                endTime: formData.get('endTime') || null,
                idTimeOfDay: parseInt(formData.get('idTimeOfDay')),
                idTraffic: formData.get('idTraffic') ? parseInt(formData.get('idTraffic')) : null,
                idRoadType: formData.get('idRoadType') ? parseInt(formData.get('idRoadType')) : null,
                idWeather: formData.get('idWeather') ? parseInt(formData.get('idWeather')) : null,
                newWeatherType: (formData.get('newWeatherType') || '').trim() || null,
                newTrafficType: (formData.get('newTrafficType') || '').trim() || null,
                newRoadTypeName: (formData.get('newRoadTypeName') || '').trim() || null,
                idManeuver: formData.get('idManeuver') ? parseInt(formData.get('idManeuver')) : null
            };
            
            // Send to PHP backend
            fetch('api/save_experience.php', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(result => {
                if (result.success) {
                    showToast('Experience saved', 'success');
                    try {
                        sessionStorage.setItem('flash', 'Experience saved successfully');
                        sessionStorage.setItem('flashType', 'success');
                    } catch (e) {}
                    setTimeout(() => window.location.href = 'summary.html', 400);
                } else {
                    showToast('Error: ' + result.message, 'error');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showToast('An error occurred while saving.', 'error');
            });
        }
    </script>
</body>
</html>